<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cousinades 2025 — Inscription & Choix de menu (v3)</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#f7f7fb; margin:0; }
    header { background:#fff; border-bottom:1px solid #ccc; padding:10px 16px; position:sticky; top:0; }
    h1 { margin:0; font-size:1.2rem; }
    main { max-width:1000px; margin:0 auto; padding:16px; display:grid; gap:20px; grid-template-columns:2fr 1fr; }
    .card { background:#fff; border:1px solid #ddd; border-radius:10px; padding:16px; }
    .row { display:flex; flex-wrap:wrap; gap:12px; }
    label { font-weight:600; display:block; margin:6px 0 2px; }
    input, select, textarea { width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; }
    .adult-card,.child-card { border:1px solid #ddd; padding:12px; border-radius:10px; margin-bottom:10px; background:#f9fafb; }
    .summary { background:#fff; border:1px solid #ddd; border-radius:10px; padding:16px; position:sticky; top:60px; }
    .btn { padding:10px 14px; border:none; border-radius:6px; cursor:pointer; font-weight:700; }
    .btn.primary { background:#2563eb; color:#fff; }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }
    .success-box,.error-box { margin-top:12px; padding:10px; border-radius:6px; display:none; }
    .success-box { background:#ecfdf5; border:1px solid #bbf7d0; color:#065f46; }
    .error-box { background:#fff1f2; border:1px solid #fecaca; color:#7f1d1d; }
  </style>
</head>
<body>
  <header><h1>Cousinades 2025 — Formulaire v3</h1></header>
  <main>
    <section class="card">
      <form id="resaForm">
        <h2>Coordonnées</h2>
        <div class="row">
          <div style="flex:1"><label>Nom</label><input id="refNom" required></div>
          <div style="flex:1"><label>Prénom</label><input id="refPrenom" required></div>
        </div>
        <div class="row">
          <div style="flex:1"><label>Email</label><input id="refEmail" type="email" required></div>
          <div style="flex:1"><label>Téléphone</label><input id="refTel" required></div>
        </div>

        <h2>Menus adultes</h2>
        <label>Nombre</label>
        <input id="nbAdults" type="number" value="1" min="0" max="50">
        <div id="adultList"></div>

        <h2>Menus enfants</h2>
        <label>Nombre</label>
        <input id="nbKids" type="number" value="0" min="0" max="50">
        <div id="childList"></div>

        <h2>Allergies</h2>
        <select id="allergies"><option value="non">Non</option><option value="oui">Oui</option></select>
        <textarea id="allergiesTexte" disabled placeholder="Précisez les allergies"></textarea>

        <p><b>Merci de faire le virement avant le 31 août 2025</b><br>
        IBAN : FR76 3000 3018 9000 0502 5784 002<br>
        Titulaire : MME EMILIE BERTOUT - ROUSSEAU</p>

        <button type="submit" class="btn primary">Envoyer la réservation</button>
        <div id="successBox" class="success-box"></div>
        <div id="errorBox" class="error-box"></div>
      </form>
    </section>

    <aside class="summary">
      <h3>Total</h3>
      <div><span id="grandTotal">—</span></div>
    </aside>
  </main>

  <script>
    const CONFIG = {
      PRIX_MENU_ADULTE: 52,
      PRIX_MENU_ENFANT: 19,
      DEADLINE_VIREMENT: "31 août 2025",
      RIB_DETAILS: "FR76 3000 3018 9000 0502 5784 002",
      APPS_SCRIPT_URL: "https://script.google.com/macros/s/AKfycbz32JoIHo9cijnITf4GXsfIHixIOnPluxXbXFLzPG25V7mZ1ybFVwMSBoC5xRWuHUUL6A/exec"
    };

    const entreeOptions = [
      "Tarte fine tomate chèvre olive",
      "Flan saumon courgette crème aneth"
    ];
    const platOptions = [
      "Dos de cabillaud pesto rouge",
      "Pavé de veau sauce poivre"
    ];
    const dessertOptions = [
      "Tarte citron vert",
      "Mi-cuit chocolat crème anglaise"
    ];
    const vinOptions = ["Aucun", "Vin blanc", "Vin rouge"];

    const byId = id => document.getElementById(id);

    function adultCardTemplate(i){
      return `<div class="adult-card" data-index="${i}">
        <h4>Adulte #${i+1}</h4>
        <div class="row">
          <div><label>Nom</label><input name="a_nom"></div>
          <div><label>Prénom</label><input name="a_prenom"></div>
        </div>
        <div class="row">
          <div><label>Entrée</label><select name="a_entree">${entreeOptions.map(v=>`<option>${v}</option>`).join("")}</select></div>
          <div><label>Plat</label><select name="a_plat">${platOptions.map(v=>`<option>${v}</option>`).join("")}</select></div>
          <div><label>Dessert</label><select name="a_dessert">${dessertOptions.map(v=>`<option>${v}</option>`).join("")}</select></div>
        </div>
        <div><label>Vin</label><select name="a_vin">${vinOptions.map(v=>`<option>${v}</option>`).join("")}</select></div>
      </div>`;
    }
    function childCardTemplate(i){
      return `<div class="child-card" data-index="${i}">
        <h4>Enfant #${i+1}</h4>
        <div class="row">
          <div><label>Nom</label><input name="k_nom"></div>
          <div><label>Prénom</label><input name="k_prenom"></div>
        </div>
      </div>`;
    }

    function rebuildAdults(n){
      const wrap = byId("adultList"); wrap.innerHTML="";
      for(let i=0;i<n;i++) wrap.insertAdjacentHTML("beforeend", adultCardTemplate(i));
    }
    function rebuildKids(n){
      const wrap = byId("childList"); wrap.innerHTML="";
      for(let i=0;i<n;i++) wrap.insertAdjacentHTML("beforeend", childCardTemplate(i));
    }

    function readForm(){
      const nbAdults = parseInt(byId("nbAdults").value)||0;
      const nbKids = parseInt(byId("nbKids").value)||0;
      const adults = [...document.querySelectorAll(".adult-card")].map(card=>({
        nom: card.querySelector("[name='a_nom']").value,
        prenom: card.querySelector("[name='a_prenom']").value,
        entree: card.querySelector("[name='a_entree']").value,
        plat: card.querySelector("[name='a_plat']").value,
        dessert: card.querySelector("[name='a_dessert']").value,
        vin: card.querySelector("[name='a_vin']").value
      }));
      const kids = [...document.querySelectorAll(".child-card")].map(card=>({
        nom: card.querySelector("[name='k_nom']").value,
        prenom: card.querySelector("[name='k_prenom']").value
      }));
      const total = nbAdults*CONFIG.PRIX_MENU_ADULTE + nbKids*CONFIG.PRIX_MENU_ENFANT;
      return {
        contact:{nom:byId("refNom").value, prenom:byId("refPrenom").value, email:byId("refEmail").value, tel:byId("refTel").value},
        reservation:{nbAdults, nbKids, adults, kids, allergies:{present:byId("allergies").value, details:byId("allergiesTexte").value}},
        event:{virementDeadline:CONFIG.DEADLINE_VIREMENT, rib:CONFIG.RIB_DETAILS},
        prices:{grandTotal: total}
      };
    }

    async function submitForm(evt){
      evt.preventDefault();
      const btn = evt.target.querySelector("button[type=submit]");
      btn.disabled = true; btn.textContent = "Envoi...";
      const payload = readForm();
      try {
        await fetch(CONFIG.APPS_SCRIPT_URL, {method:"POST", body:JSON.stringify(payload)});
        byId("successBox").textContent = "✅ Réservation envoyée.";
        byId("successBox").style.display="block";
      } catch(e){
        byId("errorBox").textContent = "❌ Erreur d'envoi.";
        byId("errorBox").style.display="block";
      }
    }

    function init(){
      rebuildAdults(byId("nbAdults").value);
      rebuildKids(byId("nbKids").value);
      byId("nbAdults").addEventListener("input", e=>rebuildAdults(e.target.value));
      byId("nbKids").addEventListener("input", e=>rebuildKids(e.target.value));
      byId("resaForm").addEventListener("submit", submitForm);
    }
    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
