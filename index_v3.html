<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cousinades 2025 — Inscription & Choix de menu (v3)</title>
  <style>
    :root {
      --bg:#f7f7fb; --panel:#fff; --ink:#1f2937; --muted:#e5e7eb;
      --primary:#2563eb; --danger:#b91c1c; --success:#065f46
    }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto; background:var(--bg); }
    header { background:#fff; border-bottom:1px solid var(--muted); padding:12px 16px; position:sticky; top:0; z-index:10; }
    h1 { margin:0; font-size:1.2rem; }
    main { max-width:1000px; margin:0 auto; padding:16px; display:grid; gap:20px; grid-template-columns:2fr 1fr; }
    .card { background:var(--panel); border:1px solid var(--muted); border-radius:12px; padding:16px; }
    .row { display:flex; flex-wrap:wrap; gap:12px; }
    label { font-weight:600; margin:6px 0 4px; display:block; }
    input, select, textarea { width:100%; padding:8px; border:1px solid var(--muted); border-radius:6px; }
    .summary { position:sticky; top:70px; background:#fff; border:1px solid var(--muted); border-radius:12px; padding:16px; }
    .line { display:flex; justify-content:space-between; margin:6px 0; }
    .total { font-size:1.3rem; font-weight:700; }
    .btn { background:var(--primary); color:#fff; padding:10px 14px; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
    .success { display:none; color:var(--success); margin-top:8px; }
    .error { display:none; color:var(--danger); margin-top:8px; }
  </style>
</head>
<body>
<header>
  <h1>Cousinades 2025 — Formulaire v3</h1>
</header>

<main>
  <section class="card">
    <form id="resaForm">
      <h2>Coordonnées</h2>
      <div class="row">
        <div><label>Nom</label><input type="text" id="refNom" required></div>
        <div><label>Prénom</label><input type="text" id="refPrenom" required></div>
      </div>
      <div class="row">
        <div><label>Email</label><input type="email" id="refEmail" required></div>
        <div><label>Téléphone</label><input type="tel" id="refTel" required></div>
      </div>

      <h2>Convives</h2>
      <div class="row">
        <div><label>Nb Adultes</label><input type="number" id="nbAdults" value="1" min="1"></div>
        <div><label>Nb Enfants</label><input type="number" id="nbKids" value="0" min="0"></div>
      </div>

      <h2>Vin</h2>
      <div class="row">
        <div><label>Vin blanc</label><select id="vinBlanc"><option value="non">Non</option><option value="oui">Oui</option></select></div>
        <div><label>Vin rouge</label><select id="vinRouge"><option value="non">Non</option><option value="oui">Oui</option></select></div>
      </div>

      <h2>Allergies</h2>
      <select id="allergies">
        <option value="non">Non</option>
        <option value="oui">Oui</option>
      </select>
      <textarea id="allergiesTexte" placeholder="Précisez..." disabled></textarea>

      <button type="submit" class="btn">Envoyer</button>
      <div id="successBox" class="success">✅ Réservation envoyée</div>
      <div id="errorBox" class="error">❌ Erreur d’envoi</div>
    </form>
  </section>

  <aside class="summary">
    <h3>Récapitulatif</h3>
    <div class="line"><span>Adultes</span><b id="adultTotal">—</b></div>
    <div class="line"><span>Enfants</span><b id="kidTotal">—</b></div>
    <div class="line"><span>Vin blanc</span><b id="whiteWine">—</b></div>
    <div class="line"><span>Vin rouge</span><b id="redWine">—</b></div>
    <hr>
    <div class="line total"><span>Total</span><b id="grandTotal">—</b></div>
  </aside>
</main>

<script>
const CONFIG = {
  PRIX_MENU_ADULTE: 52,
  PRIX_MENU_ENFANT: 19,
  PRIX_VIN_PAR_PERSONNE: 7,
  APPS_SCRIPT_URL: "https://script.google.com/macros/s/AKfycbz32JoIHo9cijnITf4GXsfIHixIOnPluxXbXFLzPG25V7mZ1ybFVwMSBoC5xRWuHUUL6A/exec"
};

const fmtEUR = new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR'});
const byId = id => document.getElementById(id);

function updateSummary(){
  const nbA = +byId("nbAdults").value||0;
  const nbK = +byId("nbKids").value||0;
  const vinBlanc = byId("vinBlanc").value==="oui";
  const vinRouge = byId("vinRouge").value==="oui";
  const consumers = nbA;
  const vinBlancC = vinBlanc ? consumers*CONFIG.PRIX_VIN_PAR_PERSONNE : 0;
  const vinRougeC = vinRouge ? consumers*CONFIG.PRIX_VIN_PAR_PERSONNE : 0;

  const adultC = nbA*CONFIG.PRIX_MENU_ADULTE;
  const kidC = nbK*CONFIG.PRIX_MENU_ENFANT;
  const total = adultC+kidC+vinBlancC+vinRougeC;

  byId("adultTotal").textContent=fmtEUR.format(adultC);
  byId("kidTotal").textContent=fmtEUR.format(kidC);
  byId("whiteWine").textContent=vinBlanc?fmtEUR.format(vinBlancC):"—";
  byId("redWine").textContent=vinRouge?fmtEUR.format(vinRougeC):"—";
  byId("grandTotal").textContent=fmtEUR.format(total);
}

["nbAdults","nbKids","vinBlanc","vinRouge"].forEach(id=>{
  byId(id).addEventListener("input",updateSummary);
  byId(id).addEventListener("change",updateSummary);
});

byId("allergies").addEventListener("change",()=>{
  byId("allergiesTexte").disabled = byId("allergies").value!=="oui";
});

byId("resaForm").addEventListener("submit", async e=>{
  e.preventDefault();
  byId("successBox").style.display="none";
  byId("errorBox").style.display="none";

  const payload = {
    contact:{
      nom:byId("refNom").value, prenom:byId("refPrenom").value,
      email:byId("refEmail").value, tel:byId("refTel").value
    },
    reservation:{
      nbAdults:+byId("nbAdults").value,
      nbKids:+byId("nbKids").value,
      vin:{blanc:byId("vinBlanc").value==="oui",rouge:byId("vinRouge").value==="oui"},
      allergies:{present:byId("allergies").value,details:byId("allergiesTexte").value}
    }
  };

  try {
    await fetch(CONFIG.APPS_SCRIPT_URL,{method:"POST",body:JSON.stringify(payload)});
    byId("successBox").style.display="block";
  } catch {
    byId("errorBox").style.display="block";
  }
});

updateSummary();
</script>
</body>
</html>
